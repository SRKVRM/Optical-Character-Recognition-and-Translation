{%extends "base.html" %}

{%block content%}

<div class="accordion" id="accordionExample">
  <div class="card">
    <div class="card-header" id="headingOne">
      <h2 class="mb-0">
        <button class="btn btn-outline-light btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
          Select Image
        </button>
      </h2>
    </div>

    <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
      <div class="card-body">
        <form action="/upload-image" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <input type="file" class="form-control-file" name="image" id="image">
          </div>
          <button type="submit" class="btn btn-primary">Upload</button>
        </form>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-header" id="headingTwo">
      <h2 class="mb-0">
        <button class="btn btn-outline-light btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
          Capture Image
        </button>
      </h2>
    </div>
    <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
      <div class="card-body">
        <div class="camera">
          <video id="video" width="100%" 
              height="100%" autoplay>
          </video>
        </div>
        <div style="float: left;">
          <a href="#!" class="btn btn-primary" id="startbutton">
              Capture
          </a>
        </div>

        <div class="text-right">
          <a href="#!" class="btn btn-danger" 
              onClick="stop()">
              Stop Cam
          </a>
          <a href="#!" class="btn btn-success" onClick="start()">
              Start Cam
          </a>
        </div>
        <canvas id="canvas"></canvas>
        <div class="output">
            <img id="photo" alt="The screen capture will appear in this box.">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var width = 320; // We will scale the photo width to this
  var height = 0; // This will be computed based on the input stream

  var streaming = false;
  var stop = function () {
      var stream = video.srcObject;
      var tracks = stream.getTracks();
      for (var i = 0; i < tracks.length; i++) {
          var track = tracks[i];
          track.stop();
      }
      video.srcObject = null;
  }
  var start = function () {
      var video = document.getElementById('video'),
          vendorUrl = window.URL || window.webkitURL;
      var canvas = document.getElementById('canvas');
      var photo = document.getElementById('photo');
      var startbutton = document.getElementById('startbutton');
      if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ video: true })
              .then(function (stream) {
                  video.srcObject = stream;
              }).catch(function (error) {
                  console.log("Something went wrong!");
              });
      }
      video.addEventListener('canplay', function(ev) {
        if (!streaming) {
          height = video.videoHeight / (video.videoWidth / width);
        
          if (isNaN(height)) {
            height = width / (4 / 3);
          }
          
          // video.setAttribute('width', width);
          // video.setAttribute('height', height);
          canvas.setAttribute('width', width);
          canvas.setAttribute('height', height);
          streaming = true;
        }
    }, false);
    startbutton.addEventListener('click', function(ev) {
        takepicture();
        ev.preventDefault();
    }, false);

    clearphoto();
  }

  function clearphoto() {
      var context = canvas.getContext('2d');
      context.fillStyle = "#AAA";
      context.fillRect(0, 0, canvas.width, canvas.height);

      var data = canvas.toDataURL('image/png');
      photo.setAttribute('src', data);
  }

  function takepicture() {
      var context = canvas.getContext('2d');
      if (width && height) {
          canvas.width = width;
          canvas.height = height;
          context.drawImage(video, 0, 0, width, height);

          var data = canvas.toDataURL('image/png');
          photo.setAttribute('src', data);
      } else {
          clearphoto();
      }
  }

  $(function () {
      start();
  });  

</script>

{% endblock %}